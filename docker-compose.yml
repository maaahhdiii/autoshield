version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: autoshield-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: autoshield
      POSTGRES_USER: autoshield
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_in_production}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./java-backend/src/main/resources/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    # Only expose to internal Docker network (no host port binding)
    expose:
      - "5432"
    networks:
      - autoshield-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U autoshield"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Java Backend (Spring Boot)
  java-backend:
    build:
      context: ./java-backend
      dockerfile: Dockerfile
    container_name: autoshield-backend
    restart: unless-stopped
    ports:
      - "8080:8080"  # Expose to Proxmox host
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: autoshield
      DB_USER: autoshield
      DB_PASSWORD: ${DB_PASSWORD:-autoshield_secure_pass}
      SERVER_PORT: 8080
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
      PYTHON_AI_URL: http://python-ai:8000
      KALI_MCP_URL: http://kali-mcp:8001
      JWT_SECRET: ${JWT_SECRET:-autoshield_jwt_secret_key_change_in_production_minimum_256_bits_required_for_hs256}
    depends_on:
      postgres:
        condition: service_healthy
      python-ai:
        condition: service_healthy
      kali-mcp:
        condition: service_healthy
    networks:
      - autoshield-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # React Frontend (Dashboard)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: autoshield-frontend
    restart: unless-stopped
    ports:
      - "3000:80"  # Expose to Proxmox host (Nginx serves on port 80 inside container)
    environment:
      VITE_API_URL: http://java-backend:8080
    depends_on:
      java-backend:
        condition: service_healthy
    networks:
      - autoshield-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Python AI Controller (FastAPI)
  python-ai:
    build:
      context: ./python-ai
      dockerfile: Dockerfile
    container_name: autoshield-ai
    restart: unless-stopped
    ports:
      - "8000:8000"  # Expose to Proxmox host (access from LAN)
    environment:
      MCP_SERVER_URL: ${MCP_SERVER_URL:-http://kali-mcp:8001/sse}
      JAVA_BACKEND_URL: ${JAVA_BACKEND_URL:-http://java-backend:8080}
      MCP_AUTH_TOKEN: ${MCP_AUTH_TOKEN:-secure_token_change_in_production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      THREAT_SCORE_THRESHOLD: ${THREAT_SCORE_THRESHOLD:-70}
      WHITELISTED_IPS: ${WHITELISTED_IPS:-127.0.0.1,::1}
      ENABLE_AUTO_BLOCK: ${ENABLE_AUTO_BLOCK:-true}
      DRY_RUN_MODE: ${DRY_RUN_MODE:-false}
    depends_on:
      kali-mcp:
        condition: service_healthy
    networks:
      - autoshield-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Kali MCP Server (Security Tools)
  kali-mcp:
    build:
      context: ./kali-mcp
      dockerfile: Dockerfile
    container_name: autoshield-kali
    restart: unless-stopped
    ports:
      - "8001:8001"  # Expose to Proxmox host for monitoring
    environment:
      MCP_AUTH_TOKEN: ${MCP_AUTH_TOKEN:-secure_token_change_in_production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ALLOWED_IP_RANGES: ${ALLOWED_IP_RANGES:-192.168.0.0/16,10.0.0.0/8}
    # Privileged mode required for network scanning and firewall management
    # This container needs to manage iptables/ufw and perform network scans
    privileged: true
    cap_add:
      - NET_ADMIN    # Required for firewall management
      - NET_RAW      # Required for Nmap raw packet scanning
      - SYS_ADMIN    # Required for system-level operations
    network_mode: bridge  # Use bridge network for scanning capabilities
    volumes:
      # Mount host auth logs for analysis (read-only)
      - /var/log/auth.log:/var/log/auth.log:ro
      # Optional: Mount Proxmox host network config for advanced scanning
      # - /etc/network:/host/network:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  autoshield-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/autoshield/data/postgres
